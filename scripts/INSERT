#!/bin/bash
# INSERT
VERSION="0.0.7-1" # Main deploy script version
CAJA_SCRIPTS_DIR="$HOME/.config/caja/scripts"
SOURCE_DIR="./scripts"

# Scripts to install (format: "source_name:target_name")
SCRIPTS=(
  "insert_readme:INSERT README"
  "create_readme:CREATE README"
  "test_zenity:TEST ZENITY"
  "test_caja:TEST CAJA"
  "test_caja_zenity:TEST CAJA ZENITY"
)

# Check if CAJA is installed
if ! command -v caja &>/dev/null; then
  echo "Error: Caja file manager doesn't appear to be installed"
  exit 1
fi

# Create CAJA scripts directory if it doesnâ€™t exist
mkdir -p "$CAJA_SCRIPTS_DIR" || {
  echo "Error: Failed to create $CAJA_SCRIPTS_DIR"
  exit 1
}

echo "Deploying scripts (Main version: $VERSION)"

# Install each script and capture versions
for script in "${SCRIPTS[@]}"; do
  SOURCE_NAME="${script%%:*}"
  TARGET_NAME="${script##*:}"
  SOURCE_PATH="$SOURCE_DIR/$SOURCE_NAME.sh"
  TARGET_PATH="$CAJA_SCRIPTS_DIR/$TARGET_NAME"

  # Check if source script exists
  if [ ! -f "$SOURCE_PATH" ]; then
    echo "Error: Source script $SOURCE_PATH not found"
    continue
  fi

  # Extract sub-script version (default to "Unversioned" if missing)
  SUB_VERSION=$(grep '^VERSION=' "$SOURCE_PATH" | cut -d'"' -f2)
  SUB_VERSION="${SUB_VERSION:-Unversioned}"

  # Check existing version in target
  if [ -f "$TARGET_PATH" ]; then
    EXISTING_VERSION=$(grep '^VERSION=' "$TARGET_PATH" | cut -d'"' -f2)
    EXISTING_VERSION="${EXISTING_VERSION:-Unversioned}"
    if [ "$EXISTING_VERSION" = "$SUB_VERSION" ]; then
      echo "Script $TARGET_NAME (v$SUB_VERSION) already installed"
      continue
    else
      echo "Updating $TARGET_NAME from v$EXISTING_VERSION to v$SUB_VERSION"
    fi
  else
    echo "Installing $TARGET_NAME (v$SUB_VERSION)"
  fi

  # Copy and configure the script
  cp "$SOURCE_PATH" "$TARGET_PATH"
  chmod +x "$TARGET_PATH"
done

echo "Installation complete"
echo "Deployed with main version: $VERSION"
